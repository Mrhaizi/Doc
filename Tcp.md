# Tcp

## 三次握手
1. **第一次握手**（SYN）：
   客户端向服务器发送一个SYN（Synchronize Sequence Numbers）包，表示希望建立连接，同时初始化一个序列号。这个请求包含了客户端的初始序列号`seq=x`。此时客户端进入“SYN_SENT”状态，等待服务器响应。

2. **第二次握手**（SYN-ACK）：
   服务器接收到客户端的SYN包后，会确认收到请求，并向客户端发送一个SYN-ACK包，表示同意连接。这个SYN-ACK包包含了服务器的初始序列号`seq=y`，同时对客户端的SYN进行确认`ack=x+1`。此时服务器进入“SYN_RECEIVED”状态。

3. **第三次握手**（ACK）：
   客户端接收到服务器的SYN-ACK包后，再次发送一个ACK包，表示对服务器的SYN-ACK确认，同时带上服务器的序列号`ack=y+1`。此时客户端进入“ESTABLISHED”状态，服务器接收到ACK后也进入“ESTABLISHED”状态，双方连接建立，接下来可以开始数据传输。

### 举例说明

假设客户端序列号初始值为100，服务器序列号初始值为200，三次握手的过程可以表示如下：

1. **客户端**发送SYN包，`seq=100`，进入“SYN_SENT”状态。
2. **服务器**接收SYN包，发送SYN-ACK包，`seq=200，ack=101`，进入“SYN_RECEIVED”状态。
3. **客户端**收到SYN-ACK包，发送ACK包，`seq=101，ack=201`，进入“ESTABLISHED”状态。
4. **服务器**收到ACK包，进入“ESTABLISHED”状态，连接建立完成。

通过三次握手，TCP可以确保通信双方具备数据收发的能力，并且准备好了序列号，从而为接下来的可靠数据传输提供了基础。



### 注意事项
1. 当第一次握手，服务端接收到syn时，会将连接放入半连接队列中,第三次握手，再接收到ack时，又将连接放入全连接队列当中
2. 当半连接队列满了后，会丢弃syn，导致客户端connect time out错误
3. 当全连接队列满了后，会丢弃ack导致客户端Read timed out错误
4. 上面的错误可以通过增加相应连接队列的长度来解决,net.ipv4.tcp_max_syn_backlog(半连接),和net.core.somaxconn(全连接).

